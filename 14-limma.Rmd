# Limma

## Core principle

[Limma](https://bioconductor.org/packages/release/bioc/html/limma.html) เป็นหนึ่งใน `bioconductor package` ที่นิยมใช้อย่างแพร่หลายในการศึกษา differential gene expression ในงานทดลอง `microarray` และ `RNA-seq`

หลักการสำคัญของ `limma` คือการใช้สมการถดถอยเชิงเส้นในการหาความแตกต่างของการแสดงออกของยีนระหว่างกลุ่มสองกลุ่ม (differential gene expression) โดยมีสมมติฐานเบื้องต้นว่าค่าพื้นหลังที่อ่านได้จาก probe ของ microarray นั้นมีการกระจายตัวแบบ [normal distribution](#norm-dist)

-   $H_{0}$: ไม่มีความแตกต่างกันในการแสดงออกของยีน

-   $H_{a}$: มีความแตกต่างกันในการแสดงออกของยีน

```{r limma_diff_mech, echo = FALSE, message = FALSE, warning = FALSE}
names(GSE63514) <-  c("prob", GSE63514_meta$title)
GSE63514_two_group <- GSE63514 |> select(prob, contains(c("Normal", "Cancer")))
GSE63514_long <- GSE63514_two_group |>
  pivot_longer(-prob, names_to = "Case", values_to = "Intensity") |> 
  mutate(Group = gsub("-\\d+", "", Case)) |> 
  filter(prob == "202055_at") |> 
  mutate(Group2 = case_match(Group,"Normal" ~ 0,
                            "Cancer" ~ 1
                            ))

ggplot(GSE63514_long, aes(x = Group2, y = Intensity)) + 
  geom_jitter(width = 0.1, alpha = 0.6, aes(col = Group)) +
  geom_smooth(aes(group = 1), method = "lm", formula = y~x, se = FALSE,
              color = "black", linewidth = 0.5) +
  geom_smooth(aes(group = 1), method = "lm", formula = y~1, se = FALSE,
              linetype = "dotdash", color = "black", linewidth = 0.5) +
  scale_x_continuous(breaks = c(0,1)) +
  xlab("Group") +
  theme_bw() +
  theme(aspect.ratio = 1)
```

จากกราฟ เส้นประคือเส้นของ $H_{0}$ หมายถึงการแสดงออกของยีนทั้งหมดสามารถหาได้โดยใช้ค่าเฉลี่ยโดยรวมของทั้งสองกลุ่ม $\text{Intensity} = \theta + \epsilon$ และ เส้นทึบคือเส้นของ $H_{a}$ หมายคือเส้นสมการถดถอยที่ลากผ่านค่าเฉลี่ยของแต่ละกลุ่ม $\text{Intensity }= \theta + \theta_{1}*\text{Group} + \epsilon$ ซึ่งทั้งหมดนี้ ก็คือเส้นสมการถดถอยเชิงเส้นตามปกติโดยทั่วไปนั่นเอง โดย limma ซึ่งความแตกต่างตามสสมมติฐานนั้น จะถูกทดสอบ โดย $t$-test ($F$-test ถ้ามากกว่าสองกลุ่ม)

คำถามคือ วิธีการนี้แตกต่างอย่างไรกับการสร้างสมการถดถอยโดยทั่วไป? เนื่องจากงานประเภท bioinformatics นั้นมักมีค่าใช้จ่ายในแต่ละการทดลองสูง จำนวนตัวอย่างที่นำมาใช้ในการทดลองนั้นมีไม่มากนัก เช่น 3-4 ตัวอย่างต่อกลุ่ม

$$
t = \frac{\beta}{SE} = \frac{\beta}{SS/\sqrt{n}}
$$

ซึ่งเมื่อพิจารณาจากสูตรแล้ว จะเห็นว่าจำนวนตัวอย่างที่ต่ำ ส่งผลให้ $t$ มากเกินไป ส่งผลให้การทดสอบโดยวิธีปกตินั้นมี power ทีต่ำมาก เนื่องจากมีกลุ่มตัวอย่างน้อยเกินไป

```{r}
# genes_var_3_samples <- apply(exprs(GSE63514_3), 1, 
#                              \(x) var(x)/ncol(exprs(GSE63514_3))) 
# genes_var_all_samples <- apply(exprs(GSE63514_NC),1,
#                              \(x) var(x)/ncol(exprs(GSE63514_NC))) 
# 
# data.frame(var3 = genes_var_3_samples, varall = genes_var_all_samples) |> 
#   pivot_longer(everything(), names_to = "sample", values_to = "SE") |> 
#   ggplot(aes(x = SE*1000, fill = sample)) + geom_density(alpha = 0.5) +
#   scale_x_continuous(breaks = seq(0,100,10), limits = c(0,100)) +
#   theme_bw()
```

ผู้นิพนธ์ limma นั้นได้แก้ปัญหานี้โดยใช้หลักการสถิติแบบ Bayesian ชื่อว่า moderated $t$-test โดยหลักการคือ การยืมข้อมูลของความแปรปรวนมาจากทุกยีน มาสร้างเป็น **ความน่าจะเป็นก่อนหน้า (prior probability)**
