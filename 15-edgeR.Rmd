# edgeR

## Principle

[edgeR](https://bioconductor.org/packages/release/bioc/html/edgeR.html) (Empirical Analysis with Gene Expression in R) เป็น `bioconductor package` ที่นิยมใช้ในการศึกษา DGE ในการทดลอง RNA-seq ซึ่งตั้งอยู่บนสมมติฐานที่แตกต่างจาก limma เนื่องจากข้อมูล RNA-seq นั้นมีคุณสมบัติที่แตกต่างจากข้อมูลประเภท Microarray ดังนี้

-   `log(intensity)` ของ Microarray ซึ่งเป็นข้อมูล Continuous จึงสามารถใช้โมเดลแบบ Linear ได้ แต่ ข้อมูล RNA-seq นั้นเป็นข้อมูล `read count` ที่ได้จากการนับ Sequencing จึงเหมาะกับการใช้โมเดลแบบ Poisson มากกว่า

-   Heteroscedasticity สูง จึงไม่สามารถใช้สมการถดถอยแบบ Poisson โดยปกติได้

```{r echo = FALSE, fig.show="hold", out.width="50%", message=FALSE, warning = FALSE}
library(edgeR)
bladder <- read_csv("Resource/bladder_matrix.csv") |> 
  filter(!is.na(`...1`)) |> 
  column_to_rownames("...1") 
bladder_mat <- as.matrix(bladder)

set.seed(123)
pois_var_mat <- t(sapply(rowMeans(bladder_mat), rpois, n=6))

plotMeanVar(DGEList(pois_var_mat), main = "Poisson distributed data")
plotMeanVar(DGEList(bladder_mat), main = "RNA-seq sample")
```

**กราฟซ้าย** คือความสัมพันธ์ของค่าเฉลี่ยและความแปรปรวนของการกระจายตัวแบบ Poisson โดยทั่วไป ส่วน**กราฟขวา** เป็นการกระจายตัวของข้อมูล RNA-seq จะเห็นว่าเมื่อค่าเฉลี่ยเพิ่มมากขึ้นนั้น ความแปรปรวนจะเพิ่มในอัตราส่วนที่มากกว่า ทั้งนี้ เนื่องจาก มีปัจจัยของความแปรปรวนที่ไม่ใช่ความแปรปรวนของ Technical variability จากกระบวนการ RNA sequencing (ซึ่งเป็น การกระจายตัวแบบ Poisson) เพียงอย่างเดียว แต่มีความแปรปรวนของ Biological properties ในตัวอย่างมาเกี่ยวข้องด้วย

### Negative binomial model

#### Handling biological variation

จากข้อมูลขั้นต้น สมมติฐานของ edgeR คือ RNA-seq มี Technical variation ซึ่งมีการกระจายตัวแบบ Poisson และ Biological variation ซึ่งทำให้เกิดความแปรปรวนที่นอกเหนือจาก Poisson (Extra poisson variability) ส่งผลให้เกิดข้อมูลแบบ Overdispersion ซึ่งเมื่อทำการสร้างสมถดถอยของความสัมพันธ์ระหว่างความแปรปรวนกับค่าเฉลี่ยจะได้ว่า

$$
var(y_{gi}) = E_{\pi}[var(y|\pi)] + var_{\pi}[E(y|\pi)] = \mu_{gi} + \phi_{g}\mu^{2}_{gi}
$$

$$
CV^{2} = 1/\mu_{gi} + \phi
$$

โดยที่ $\sqrt{1/\mu_{gi}}$ คือ Coefficient variation ($S/\mu$; CV) จากการกระจายตัวแบบ Poisson ส่วน $\sqrt{\phi}$ คือ รากที่สองของ CV จากการกระบวนการอื่น ซึ่งในที่นี้คือ Biological properties ของตัว Sample ดังนั้นจะได้ว่า

$$
\text{Total CV}^{2} = \text{Technical CV}^{2} + \text{Biological CV}^{2}
$$

สมมติฐานของ edgeR นั้นตั้งอยู่บนพื้นฐานที่ว่า Technical CV นั้นจะลดลงเมื่อจำนวน Sequencing depth นั้นเพิ่มมากขึ้น ($1/\mu_{gi}$) แต่ Biological CV นั้นจะยังคงอยู่ไม่ว่า Sequencing depth จะเพิ่มมากขึ้นเท่าไร ดังนั้นสิ่งสำคัญที่เป็นตัวแปรก่อกวนการวัด DGE (ซึ่ง Systemic variability) คือ Biological CV ($\sqrt{\phi}$) นั่นเอง

#### Estimation of $\phi$ and DGE

edgeR ทำการสร้างสมการถดถอย Negative binomial จากการประเมินค่า $\phi$ โดยวิธีที่เรียกว่า Quantile-adjusted maximum likelihood ซึ่งใช้จำนวน Read ทั้งหมดในแต่ละยีนมาสร้างเป็นตาราง Pseudo-count

```{r estimatedispersion, echo = FALSE, warning = FALSE}
bladder_dge <- DGEList(bladder_mat, remove.zeros = TRUE) 
keep  <- filterByExpr(bladder_dge)
bladder_dge <- estimateCommonDisp(bladder_dge[keep,]) |> estimateTrendedDisp() |> 
  estimateTagwiseDisp()

count_df <- data.frame(Counts = as.vector(bladder_dge$counts), 
           Pseudocount = as.vector(bladder_dge$pseudo.counts)) |> 
  pivot_longer(everything(), names_to = "Data", values_to = "Count")
ggplot(count_df, aes(x = log2(Count), fill = Data)) + geom_density(alpha = 0.3) + theme_bw()
```

หลังจากนั้น edgeR จะคำนวณ DGE โดยการใช้ Exact test ซึ่งเป็นการรวมโอกาสทั้งหมดที่จะสุ่มได้ Condition ที่ต้องการ ซึ่งวิธีคล้าย [Fisher's exact test](#fisher) ที่มีการคำนึงถึง effective library size และเป็นวิธี classic method ของ edgeR ที่มีข้อจำกัดคือสามารถเปรียบเทียบ DGE ได้ระหว่างสองสภาวะเท่านั้น และไม่สามารถจำลองความแปรปรวนอื่นๆ นอกเหนือจากความแปรปรวนของยีนได้

### Extension of negative binomial

นอกจาก global BCV dispersion แล้ว edgeR ยังสามารถคำนวณ BCV ของแต่ละยีนได้โดยใช้ Quasi-likelihood ของสมการถดถอย Negative binomial

$$
var(y_{gi}) = \sigma^{2}_{g}(\mu_{gi} + \phi\mu_{gi}^{2})
$$

ซึ่งหมายความว่า ทุกๆ ความแปรปรวนของ $var(y_{gi})$ ที่เพิ่มขึ้นจะถูกทำนายด้วยค่า $\phi$ (Negative binomial parameter; Global BCV) และ $\sigma^{2}$ (Quasi-likelihood parameter; Gene-specific BCV) ซึ่งปัญหาของสมการนี้คือจำนวณ replicate ที่ไม่มากพอในแต่ละยีน edgeR แก้จึงปัญหานี้โดยประยุกต์เทคนิกของ limma มาใช้ ซึ่งก็คือ Empirical Bayes ซึ่งยืมความแปรปรวนมาจากทุกยีนนั่นเอง

```{r eBayes_dispersion}
plotBCV(bladder_dge)
```
